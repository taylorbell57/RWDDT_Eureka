# Template for RW-DDT Jupyter container
# Replace <project_name>, <analysis_dir_host>, <mast_stage1_host>, <uncalibrated_host>,
# <planet>, <visit>, <analyst>, <uid>, <gid>, <hostport>,
# <crds_dir>, <crds_target>, <crds_bind_mode>, and <crds_path>.
# Do not commit this file after filling in paths. Keep user-specific versions local.

# IMPORTANT:
# Compose isolates resources by "project name". Since multiple analysts may run on a shared host,
# we set a unique project name to avoid interference.
name: <project_name>

services:
  rwddt_eureka:
    # Prefer a tagged image for reproducibility; override via IMAGE env if desired
    image: ${IMAGE:-tbell664/rwddt_eureka:latest}

    # For local development (uncomment to build locally instead of pulling):
    # build:
    #   context: .
    #   args:
    #     NB_UID: ${UID:-1000}
    #     NB_GID: ${GID:-1000}
    #     EUREKA_REF: ${EUREKA_REF:-3a67244}
    #     NOTEBOOKS_REPO: ${NOTEBOOKS_REPO:-https://github.com/taylorbell57/rocky-worlds-notebooks.git}
    #     NOTEBOOKS_REF: ${NOTEBOOKS_REF:-3c97fa5}
    #     INCLUDE_NOTEBOOKS: ${INCLUDE_NOTEBOOKS:-true}

    init: true
    stop_signal: SIGINT
    stop_grace_period: 20s

    # Run container as the specified UID and GID
    user: "<uid>:<gid>"

    ports:
      - "<hostport>:8888"

    volumes:
      # Analyst folder (RW)
      - <analysis_dir_host>:/mnt/rwddt/JWST/<planet>/<visit>/<analyst>:rw

      # Optional shared Stage 1 inputs (RO) — uncomment ONLY if host dir exists
      # - <mast_stage1_host>:/mnt/rwddt/JWST/<planet>/<visit>/MAST_Stage1:ro

      # Optional shared Stage 0 inputs (RO) — uncomment ONLY if host dir exists
      # - <uncalibrated_host>:/mnt/rwddt/JWST/<planet>/<visit>/Uncalibrated:ro

      # CRDS mount
      #   split layout:  <crds_dir>:/grp/crds:ro
      #   single layout: <crds_dir>:/crds:rw
      - <crds_dir>:<crds_target>:<crds_bind_mode>

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"

    environment:
      TZ: ${TZ:-UTC}

      # Structured mode by default
      SIMPLE_MODE: ${SIMPLE_MODE:-0}

      # CRDS settings:
      CRDS_MODE: ${CRDS_MODE:-local}
      CRDS_PATH: ${CRDS_PATH:-<crds_path>}

      CONDA_CHANGEPS1: "no"

      # Used by entrypoint messaging (container listens on 8888 regardless)
      HOST_PORT: <hostport>

      PLANET: "<planet>"
      VISIT: "<visit>"
      ANALYST: "<analyst>"

    restart: unless-stopped
